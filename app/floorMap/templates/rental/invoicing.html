{% extends "dashboard.html" %}
<!-- Load utils-->
{% load i18n %}
{% load humanize %}
{% load bootstrap3 %}
{% load staticfiles %}
{% load invoicing_extras %}

{% block title %}{% trans "Invoicing" %}{% endblock %}

{% block extrajs %}
    <script src="{% static 'js/monthpicker.js' %}"></script>
{% endblock %}

{% block content %}
    <h1>{% trans "Invoicing" %}</h1>
    <div class="panel panel-default">
        <div class="panel-body">
            <form action="" method="get">
                <div class="row">
                    <div class="col-md-2">
                        {% bootstrap_form filter.form %}
                        <button type="submit" class="btn btn-primary"><i class="fa fa-calculator"></i> {% trans "Compile" %}</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    {% if filter.data %}
        {% if filter.count > 0 %}
            <table class="table table-bordered table-striped">
                <thead>
                    <tr>
                        <th colspan="2" class="text-center">{% trans "Company" %}</th>
                        <th colspan="2" class="text-center">{% trans "Room " %}</th>
                        <th colspan="5" class="text-center">{% trans "Monthly amount due" %}</th>
                    </tr>
                    <tr>
                        <th>{% trans "Name" %}</th>
                        <th>{% trans "Person in charge" %}</th>
                        <th>{% trans "Code" %}</th>
                        <th>{% trans "Annual pricing" %}<br />{% trans "(Per sq. ft.)" %}</th>
                        <th>{% trans "Before taxes" %}</th>
                        <th>{% trans "TPS" %}</th>
                        <th>{% trans "TVQ" %}</th>
                        <th>{% trans "Total due" %}</th>
                    </tr>
                </thead>
                <tbody>
                {% regroup filter by company as company_rentals %}
                {% for company in company_rentals %}
                    {% for rental in company.list %}
                        <tr>
                        {% ifchanged rental.company.name %}
                            <td>{{ rental.company.name }}</td>
                            <td>{{ rental.company.person_in_charge.user.first_name }} {{ rental.company.person_in_charge.user.last_name }}</td>
                        {% else %}
                            <td colspan="2"></td>
                        {% endifchanged %}
                            <td>{{ rental.room }}</td>
                            <td class="text-right">{{ rental.pricing|currency|intcomma }}</td>
                            <td class="text-right">{{ rental.get_monthly_fee|currency|intcomma }}</td>
                            <td colspan="4"></td>
                        </tr>
                    {% endfor %}
                    <tr>
                        <th colspan="2"></th>
                        <th colspan="2" class="text-right">{% trans "Sub-total" %}</th>
                        <td class="text-right">{{ company.list|total_due|currency|intcomma }}</td>
                        <td class="text-right">{{ company.list|total_due|tax_tps|currency|intcomma }}</td>
                        <td class="text-right">{{ company.list|total_due|tax_tvq|currency|intcomma }}</td>
                        <td class="text-right">{{ company.list|total_due|tax_both|currency|intcomma }}</td>
                    </tr>
                {% endfor %}
                </tbody>
                <tfoot>
                    <tr>
                        <th colspan="2"></th>
                        <th colspan="2"></th>
                        <th colspan="3" class="text-right">{% trans "Grand total" %}<br />({% trans "Estimate" %})</th>
                        <th class="text-right">{{ filter|grand_total_due|currency|intcomma }}</th>
                    </tr>
                </tfoot>
            </table>
            <a href="/media/Facturation_entreprises.xlsx" class="btn btn-primary">
                <i class="fa fa-download"></i> {% trans "Export to file" %}
            </a>
        {% else %}
            <p>{% trans "No results found" %}</p>
        {% endif %}
    {% endif %}
{% endblock %}
